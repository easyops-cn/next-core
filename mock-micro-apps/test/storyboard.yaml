app:
  name: Test
  id: test
  homepage: /
  noAuthGuard: true
meta:
  functions:
  - name: sayYes
    source: |
      function sayYes() {
        console.log("sayYes() is called");
        return "yes~";
      }
  - name: sayYesYes
    typescript: true
    source: |
      function sayYesYes(): string {
        console.log("sayYesYes() is called");
        return `${FN.sayYes()} and ${FN.sayYes()}`;
      }
  customTemplates:
  - name: tpl-inner
    state:
    - name: innerHello
      expose: true
    bricks:
    - brick: span
      properties:
        textContent: '<% "track state", `Inner says ${STATE.innerHello}` %>'
  - name: tpl-basic
    state:
    - name: lazyHello
      resolve:
        useProvider: demo-basic.have-more-fun
        args:
        - |
          <% `I'm lazy (${STATE.hello})` %>
        - 1000
        lazy: true
      track: true
      onChange:
        action: console.log
        args:
        - state onChange
        - lazyHello
        - '<% EVENT.detail %>'
        - '<% 0, STATE.lazyHello %>'
    - name: hello
      value: Hello World
      onChange:
        action: console.log
        args:
        - state onChange
        - hello
        - '<% EVENT.detail %>'
        - '<% 0, STATE.hello %>'
      expose: true
    - name: asyncHello
      # if: false
      resolve:
        useProvider: demo-basic.have-more-fun
        args:
        - I'm async
        - 500
        - '<% Math.random() %>'
    proxy:
      properties:
        thing:
          ref: thingSpan
          refProperty: textContent
        status:
          ref: statusSpan
          refProperty: textContent
      slots:
        "":
          ref: container
          refSlot: ""
      events:
        "yo":
          ref: thingSpan
          refEvent: click
    bricks:
    - brick: div
      ref: container
      slots:
        "":
          bricks:
          - brick: span
            ref: thingSpan
          - brick: span
            ref: statusSpan
            lifeCycle:
              onPageLoad:
                action: tpl.dispatchEvent
                args:
                - oops
                - detail: yaks
            events:
              click:
              - action: console.log
                args:
                - status click
                - '<% EVENT.detail %>'
              - action: tpl.dispatchEvent
                args:
                - oops
                - detail: yaks
          - brick: demo-basic.button-group
            properties:
              useBrick:
                brick: tpl-inner
                properties:
                  innerHello: '<% `"I say ${DATA} and ${STATE.asyncHello}"` %>'
          # - brick: span
          #   properties:
          #     textContent: "<% 'track state', STATE.asyncHello %>"
          #   lifeCycle:
          #     onPageLoad:
          #     - action: console.log
          #       args:
          #       - "STATE.asyncHello"
          #       - "<% STATE.asyncHello %>"
          #     - action: state.load
          #       args:
          #       - lazyHello
          #       callback:
          #         success:
          #           action: console.log
          #           args:
          #           - lazyHello
          #           - "<% 1, STATE.lazyHello %>"
routes:
- path: ${APP.homepage}
  # if: '<% !QUERY.redirect %>'
  if: '${QUERY.redirect|not}'
  type: redirect
  redirect: '<% "/?redirect=1" %>'
- path: ${APP.homepage}
  if: '<% +QUERY.redirect === 1 %>'
  permissionsPreCheck:
  - abc
  - def
  context:
  - name: a
    value: 'a:b'
  - name: x
    resolve:
      useProvider: demo-basic.have-more-fun
      args:
      - '<% CTX.r %>'
      - 0
      transform:
        # value: '<% `{{${DATA}}}` %>'
        value: '{{{@{|add:"!"}}}}'
  - name: x
    if: '<% !CTX.r %>'
    resolve:
      useProvider: demo-basic.have-more-fun
      args:
      - '<% CTX.r %>'
      transform:
        value: '<% `{${DATA}}` %>'
  - name: y
    resolve:
      useProvider: demo-basic.have-more-fun
      args:
      - '<% CTX.r %>'
      - 0
      transform:
        value: '<% `「${DATA}」` %>'
    onChange:
      action: console.log
      args:
      - context changed
      - y
      - '<% EVENT.detail %>'
  - name: z
    value: '<% `z:${CTX.y}` %>'
    track: true
    onChange:
      action: console.log
      args:
      - context changed
      - z
      - '<% EVENT.detail %>'
  - name: r
    resolve:
      useProvider: demo-basic.have-fun
  - name: lazy
    resolve:
      useProvider: demo-basic.have-more-fun
      args:
      - '"lazy"'
      - 2000
      lazy: true
  bricks:
  - brick: basic.demo-button
    properties:
      label: "Hi:"
    slots:
      "":
        type: bricks
        bricks:
        - brick: span
          properties:
            textContent: OK
  - brick: demo-basic.y-button
    properties:
      label: "Hello:"
      textContent: world
    events:
      oops:
      # - action: context.replace
      #   args:
      #   - y
      #   - '<% `clicked:${CTX.y}` %>'
      - action: context.refresh
        args:
        - y
        callback:
          success:
            action: console.log
            args:
            - context replaced
            - '<% EVENT.detail %>'
            - '<% CTX.y %>'
            - '<% CTX.z %>'
      - action: console.log
        args:
        - '<% EVENT.detail %>'
        - '<% CTX.x %>'
        async: true
      - action: console.log
        args:
        - '<% EVENT.detail %>'
        - immediately
  # - brick: demo-basic.y-button
  #   properties:
  #     label: "你好:"
  #     textContent: 世界
  - brick: demo-basic.button-group
  - brick: div
    properties:
      title: '<% CTX.y %>'
    slots:
      "":
        type: bricks
        bricks:
        # - brick: demo-form.f-input
        #   properties:
        #     label: "Name:"
        # - brick: demo-form.f-select
        #   permissionsPreCheck:
        #   - xyz
        #   properties:
        #     label: |
        #       <% `!Gender (${PROCESSORS.demoBasic.sayHello()},${FN.sayYesYes()}) <${CTX.x}>` %>
        - brick: span
          properties:
            textContent: |
              <%
                "track context",
                (PERMISSIONS.check("opq") ? "Yes" : "No"),
                `y:${CTX.y},z:${CTX.z}`
              %>
          lifeCycle:
            onBeforePageLeave:
            - action: history.block
              # if: |
              #   <% !PROCESSORS.demoBasic.sayHello() %>
              if: false
              args:
              - Oops
            - action: console.log
              args:
              - 'onBeforePageLeave'
              # - '<% PROCESSORS.demoBasic.sayHello() %>'
              - '<% EVENT %>'
              - '<% CTX.y %>'
              - '<% CTX.z %>'
            onBeforePageLoad:
            - action: console.log
              args:
              - 'onBeforePageLoad'
              - '<% EVENT %>'
              - '<% CTX.y %>'
              - '<% CTX.z %>'
            - action: theme.setTheme
              args:
              - dark-v2
            onPageLoad:
              action: console.log
              args:
              - 'onPageLoad'
              - '<% EVENT %>'
              - '<% CTX.y %>'
              - '<% CTX.z %>'
            onAnchorLoad:
              action: console.log
              args:
              - 'onAnchorLoad'
              - '<% EVENT %>'
              - '<% CTX.y %>'
              - '<% CTX.z %>'
            onAnchorUnload:
              action: console.log
              args:
              - 'onAnchorUnload'
              - '<% EVENT %>'
              - '<% CTX.y %>'
              - '<% CTX.z %>'
            onPageLeave:
              action: console.log
              args:
              - 'onPageLeave'
              - '<% EVENT %>'
              - '<% CTX.y %>'
              - '<% CTX.z %>'
        - brick: a
          properties:
            textContent: Go outside
            href: '/oops'

  # - brick: demo-basic.have-fun
  # - brick: demo-basic.have-more-fun
  # - brick: demo-basic.have-no-fun
- path: ${APP.homepage}
  if: '<% +QUERY.redirect === 2 %>'
  context:
  - name: datum
    value: a
  bricks:
  - brick: demo-basic.x-button
    properties:
      label: X
    events:
      click:
        action: context.replace
        args:
        - datum
        - b
  - brick: demo-basic.button-group
    properties:
      datum: '<% "track context", CTX.datum %>'
      # useBrick:
      #   if: '<% DATA === "b" %>'
      #   brick: demo-basic.x-button
      #   properties:
      #     label: '<% `Label for "${DATA}"` %>'
      #     dataset:
      #       iid: 1
      #   slots:
      #     "":
      #       bricks:
      #       - brick: span
      #         properties:
      #           textContent: '<% `Content for "${DATA}"` %>'
      #           dataset:
      #             iid: 2
      useBrick:
        brick: tpl-basic
        properties:
          thing: '<% `Thing for "${DATA}"` %>'
          status: '<% `Status for "${DATA}"` %>'
          hello: '<% `Hello for "${DATA}"` %>'
        events:
          yo:
            action: console.log
            args:
            - yo
            - '<% EVENT %>'
  - brick: tpl-basic
    if: false
    properties:
      thing: Template
      status: Works!
      hello: 你好
    slots:
      "":
        type: bricks
        bricks:
        - brick: span
          properties:
            textContent: "~~"
            # textContent: "<% 0, STATE.hello %>"
    #       lifeCycle:
    #         onPageLoad:
    #           action: console.log
    #           args:
    #           - "1. STATE.hello"
    #           - "<% 1, STATE.hello %>"
    # lifeCycle:
    #   onPageLoad:
    #     action: console.log
    #     args:
    #     - "2. STATE.hello"
    #     - "<% 2, STATE.hello %>"
    events:
      yo:
        action: console.log
      oops:
        action: console.log
