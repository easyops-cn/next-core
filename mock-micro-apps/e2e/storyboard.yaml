app:
  name: E2E Tests
  id: e2e
  homepage: /e2e
  noAuthGuard: true
  standaloneMode: true
  userConfig:
    settings:
      featureFlags:
        incremental-sub-route-rendering: true
meta:
  customTemplates:

  # 正确示例
  - name: tpl-dynamic-table
    state:
    - name: fields
    - name: data
    - name: useBrick
    bricks:
    - brick: e2e.simple-table
      properties:
        data: <%= STATE.data %>
        columns: |
          <%~
            'track state',
            STATE.fields.map((field) => ({
              dataIndex: field,
              useBrick: STATE.useBrick
            }))
          %>

  - name: tpl-use-brick-in-expr
    state:
    - name: fields
    - name: data
    - name: test
      value: Test
    bricks:
    - brick: tpl-dynamic-table
      properties:
        fields: <%= STATE.fields %>
        data: <%= STATE.data %>
        useBrick:
          brick: span
          properties:
            textContent: '<%= `${STATE.test}: ${DATA}` %>'
          events:
            click:
            - action: tpl.dispatchEvent
              args:
              - something
              - detail: happened
            - useProvider: e2e.return-by-timeout
              args:
              - 100
              - C
              callback:
                success:
                  action: state.update
                  args:
                  - test
                  - New Test

  # 错误示例
  - name: tpl-use-brick-in-expr-wrong
    state:
    - name: fields
    - name: data
    - name: test
      value: Test
    bricks:
    - brick: e2e.simple-table
      properties:
        data: <%= STATE.data %>
        columns: |
          <%~
            'track state',
            STATE.fields.map((field) => ({
              dataIndex: field,
              useBrick: {
                brick: 'span',
                properties: {
                  // Error: Using "STATE" outside of a custom template
                  textContent: '<% `${STATE.test}: ${DATA}` %>'
                },
                events: {
                  click: {
                    action: 'tpl.dispatchEvent',
                    args: [
                      'something',
                      { detail: 'happened' }
                    ]
                  }
                }
              }
            }))
          %>

  - name: tpl-a
    state:
    - name: x
      value: X
    - name: z
      value: Z
      expose: true
    bricks:
    - brick: e2e.list-by-use-brick
      properties:
        data: [1, 2]
        useBrick:
          brick: div
          properties:
            textContent: '<% `${STATE.x}:${STATE.z}:${DATA}` %>'
    - brick: e2e.list-by-use-brick
      properties:
        data: [0]
        useBrick:
          brick: div
          children:
          - brick: tpl-modal
            portal: true
            properties:
              m: '<% `${STATE.z}:${DATA}` %>'

  - name: tpl-b
    state:
    - name: x
      value: X
    - name: z
      value: Z
      expose: true
    bricks:
    - brick: div
      properties:
        textContent: '<% `${STATE.x}:${STATE.z}` %>'
    - brick: tpl-modal
      portal: true
      properties:
        m: '<% STATE.z %>'

  - name: tpl-modal
    state:
    - name: m
      value: M
      expose: true
    bricks:
    - brick: div
      properties:
        style:
          position: fixed
          right: '<% `${Math.random() * 300}px` %>'
          top: '<% `${Math.random() * 300}px` %>'
        textContent: '<% `Modal:${STATE.x ?? STATE.z ?? STATE.m}` %>'

  - name: tpl-c
    state:
    - name: c
      resolve:
        useProvider: e2e.return-by-timeout
        args:
        - 100
        - C
    bricks:
    - brick: div
      ref: output
      properties:
        textContent: Inner Initial
    - brick: e2e.list-by-use-brick
      properties:
        data: [1]
        useBrick:
          brick: button
          properties:
            textContent: Click Me
          events:
            click:
              targetRef: output
              properties:
                textContent: Inner Updated
          lifeCycle:
            onMount:
              targetRef: output
              properties:
                textContent: "<% `Inner Mounted <${STATE.c}>` %>"

  - name: tpl-d
    bricks:
    - brick: div
      ref: output
      properties:
        textContent: Outer Initial
    - brick: e2e.list-by-use-brick
      properties:
        data: [2]
        useBrick:
          brick: tpl-c

  - name: tpl-x
    state:
    - name: x
      resolve:
        useProvider: e2e.return-by-timeout
        args:
        - 100
        - <% STATE.i %>
        async: true
    - name: i
    bricks:
    - brick: div
      properties:
        textContent: |
          <%= `[i: ${STATE.i}] x: ${STATE.x}` %>

routes:

- path: '${APP.homepage}/use-brick/1'
  context:
  - name: stage
    value: 1
  bricks:
  - brick: tpl-a
  - brick: eo-list-by-use-brick
    properties:
      id: my-list
      data: [3, 4]
      useBrick:
        brick: tpl-a
        properties:
          z: '<% DATA %>'
  - brick: eo-list-by-use-brick
    properties:
      id: my-list-2
      data: [7, 8]
      useBrick:
        if: '<% DATA !== 0  %>'
        brick: div
        children:
        - brick: tpl-modal
          portal: true
          properties:
            m: '<% `S:${DATA}` %>'
  - brick: div
    properties:
      textContent: Reset
    events:
      click:
      - target: '#my-list'
        properties:
          data: |
            <%
              CTX.stage === 1
                ? [3, 5]
                : [4]
            %>
      - target: '#my-list-2'
        properties:
          data: |
            <%
              CTX.stage === 1
                ? [7, 9]
                : [8, 0]
            %>
      - action: context.replace
        args:
        - stage
        - '<% CTX.stage + 1 %>'

# Bricks within `useBrick` can access the template refs.
- path: '${APP.homepage}/use-brick/2'
  bricks:
  - brick: tpl-c

- path: '${APP.homepage}/use-brick/3'
  bricks:
  - brick: tpl-use-brick-in-expr
    properties:
      fields:
      - name
      - age
      data:
      - name: Tom
        age: 15
      - name: Jim
        age: 14
    events:
      something:
        action: console.log

# Nested `useBrick` and tpl can access the template refs.
- path: '${APP.homepage}/use-brick/4'
  bricks:
  - brick: tpl-d

# ForEach
- path: '${APP.homepage}/control-nodes/1'
  bricks:
  - brick: div
    children:
    - brick: span
      properties:
        textContent: "Hello "
    - brick: span
      properties:
        textContent: "World"
  - brick: ':forEach'
    dataSource: [1, 2]
    children:
    - brick: span
      properties:
        textContent: '<% ITEM %>'
    - brick: span
      properties:
        textContent: ','
  - brick: div
    children:
    - brick: span
      properties:
        textContent: "Goodbye "
    - brick: span
      properties:
        textContent: "World"

# Nesting forEach
- path: '${APP.homepage}/control-nodes/2'
  bricks:
  - brick: div
    properties:
      textContent: "Hello"
  - brick: ':forEach'
    dataSource: [["a"], ["b","c"]]
    children:
    - brick: div
      properties:
        textContent: '<% `start:${ITEM.length}` %>'
    - brick: ':forEach'
      dataSource: '<% ITEM %>'
      children:
      - brick: span
        properties:
          textContent: '<% ITEM %>'
    - brick: div
      properties:
        textContent: '<% `end:${ITEM.length}` %>'
  - brick: div
    properties:
      textContent: "Goodbye"

# ForEach with template with useBrick, and binding enabled
- path: '${APP.homepage}/control-nodes/3'
  context:
  - name: list
    value: [1, 2]
  bricks:
  - brick: tpl-modal
    portal: true
    properties:
      m: Hello
  - brick: ':forEach'
    dataSource: '<%= CTX.list %>'
    children:
    - brick: tpl-a
      properties:
        z: '<% ITEM %>'
  - brick: tpl-modal
    portal: true
    properties:
      m: Goodbye
  - brick: div
    properties:
      textContent: Refresh
    events:
      click:
      - if: '<% CTX.list[0] !== 1 %>'
        action: context.replace
        args:
        - list
        - [5, 6]
      - if: '<% CTX.list[0] === 1 %>'
        action: context.replace
        args:
        - list
        - [3, 4]

# ForEach with template, and binding enabled
- path: '${APP.homepage}/control-nodes/4'
  context:
  - name: list
    value: [1, 2]
  bricks:
  - brick: tpl-modal
    portal: true
    properties:
      m: Hello
  - brick: ':forEach'
    dataSource: '<%= CTX.list %>'
    children:
    - brick: tpl-b
      properties:
        z: '<% ITEM %>'
  - brick: tpl-modal
    portal: true
    properties:
      m: Goodbye
  - brick: div
    properties:
      textContent: Refresh
    events:
      click:
      - if: '<% CTX.list[0] !== 1 %>'
        action: context.replace
        args:
        - list
        - [5, 6]
      - if: '<% CTX.list[0] === 1 %>'
        action: context.replace
        args:
        - list
        - [3, 4]

# Convert binding condition
- path: '${APP.homepage}/control-nodes/5'
  context:
  - name: target
    value: 8
  bricks:
  - brick: button
    properties:
      textContent: Toggle
    events:
      click:
      - action: context.replace
        args:
        - target
        - '<% CTX.target === 8 ? 7 : 8 %>'
      - action: console.log
        args:
        - target
        - '<% CTX.target %>'
  - brick: e2e.list-by-use-brick
    properties:
      data: [7, 8]
      useBrick:
        brick: div
        children:
        - if: '<%= CTX.target === DATA %>'
          brick: div
          properties:
            textContent: '<% `Data:${DATA}` %>'

# If with direct child of If
- path: '${APP.homepage}/control-nodes/6'
  context:
  - name: value
    value: 1
  - name: constant
  bricks:
  - brick: div
    children:
    - brick: h1
      properties:
        textContent: Hello
    - brick: :if
      dataSource: <%= CTX.constant, true %>
      children:
      - brick: p
        properties:
          textContent: prefix
      - brick: :if
        dataSource: <%= CTX.value === 2 %>
        children:
        - brick: p
          properties:
            textContent: If in If <true>
        - brick: p
          slot: else
          properties:
            textContent: If in If <false>
      - brick: p
        properties:
          textContent: suffix
    - brick: button
      properties:
        textContent: Toggle
      events:
        click:
          action: context.replace
          args:
          - value
          - <% 3 - CTX.value %>

# ForEach in ForEach
- path: '${APP.homepage}/control-nodes/7'
  context:
  - name: value
    value: 1
  - name: constant
  bricks:
  - brick: div
    children:
    - brick: h1
      properties:
        textContent: Hello
    - brick: :forEach
      dataSource: <%= [CTX.constant] %>
      children:
      - brick: p
        properties:
          textContent: prefix
      - brick: :forEach
        dataSource: <%= [CTX.value] %>
        children:
        - brick: p
          properties:
            textContent: <% `ForEach in ForEach <${ITEM}>` %>
      - brick: p
        properties:
          textContent: suffix
    - brick: button
      properties:
        textContent: Toggle
      events:
        click:
          action: context.replace
          args:
          - value
          - <% 3 - CTX.value %>

# Sub-routes incremental rendering
- path: '${APP.homepage}/sub-routes/:sub'
  bricks:
  - brick: h1
    properties:
      textContent: <% `Hello [${PATH.sub}]` %>
  - brick: tpl-x
    properties:
      i: 0
  - brick: :forEach
    dataSource: [1, 2, 3, 4, 5]
    children:
    - brick: button
      properties:
        textContent: <% `Go ${ITEM}` %>
      events:
        click:
          action: history.push
          args:
          - <% `${APP.homepage}/sub-routes/${ITEM}` %>
  - brick: button
    properties:
      textContent: Go other
    events:
      click:
        action: history.push
        args:
        - ${APP.homepage}/other-route
  - brick: div
    slots:
      '':
        type: routes
        routes:
        - path: ${APP.homepage}/sub-routes/1
          context:
          - name: v
            resolve:
              useProvider: e2e.return-by-timeout
              args:
              - 100
              - 1
              async: true
          bricks:
          - brick: div
            properties:
              textContent: |
                <%= `Sub Route 1 [${CTX.v}]` %>
          - brick: tpl-x
            properties:
              i: 1
        - path: ${APP.homepage}/sub-routes/2
          context:
          - name: v
            resolve:
              useProvider: e2e.return-by-timeout
              args:
              - 100
              - 2
              async: true
          bricks:
          - brick: div
            properties:
              textContent: |
                <%= `Sub Route 2 [${CTX.v}]` %>
          - brick: tpl-x
            properties:
              i: 2
        - path: ${APP.homepage}/sub-routes/3
          context:
          - name: v
            resolve:
              useProvider: e2e.return-by-timeout
              args:
              - 100
              - 3
          bricks: []
        - path: ${APP.homepage}/sub-routes/4
          bricks:
          - brick: div
            properties:
              t: <% CTX. %>
        - path: ${APP.homepage}/sub-routes/5
          type: redirect
          redirect: ${APP.homepage}/sub-routes/2
        - path: ${APP.homepage}/other-route
          bricks:
          - brick: div
            properties:
              textContent: Fake Other Route

- path: '${APP.homepage}/other-route'
  bricks:
  - brick: div
    properties:
      textContent: Real Other Route
